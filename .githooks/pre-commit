#!/bin/bash
# Pre-commit hook to enforce 60% test coverage threshold
# Install: cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

# Color codes
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo "Running pre-commit checks..."

# Run tests with coverage (also validates tests pass)
# Note: Intentionally NOT using -race flag here for faster commits (~55s vs ~7-10min)
# Race detection is still run in CI and can be manually run with: make test
echo "→ Running tests with coverage..."
if ! go test ./... -coverprofile=coverage.out -covermode=atomic; then
    echo ""
    echo -e "${RED}✗${NC} COMMIT REJECTED: Tests failed"
    echo ""
    echo "Fix test failures before committing."
    echo "Run: go test ./..."
    rm -f coverage.out
    exit 1
fi

# Extract coverage percentage
COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')

# Check threshold
THRESHOLD=60.0

echo "→ Overall coverage: ${COVERAGE}%"

# Compare coverage to threshold (using bc for float comparison)
if [ "$(echo "$COVERAGE < $THRESHOLD" | bc)" -eq 1 ]; then
    echo ""
    echo -e "${RED}✗${NC} COMMIT REJECTED: Test coverage below threshold"
    echo "   Current:   ${COVERAGE}%"
    echo "   Required:  ${THRESHOLD}%"
    echo "   Shortfall: $(echo "$THRESHOLD - $COVERAGE" | bc)%"
    echo ""
    echo "Please add tests to reach 60% coverage before committing."
    echo "Run: go test ./... -coverprofile=coverage.out && go tool cover -html=coverage.out"
    rm -f coverage.out
    exit 1
fi

echo -e "${GREEN}✓${NC} Tests passed with ${COVERAGE}% coverage"

# Run linters
echo "→ Running linters..."
if ! make lint; then
    echo ""
    echo -e "${RED}✗${NC} COMMIT REJECTED: Linting failed"
    echo ""
    echo "Fix all linting issues shown above before committing."
    rm -f coverage.out
    exit 1
fi

echo -e "${GREEN}✓${NC} Linting passed"

# Cleanup
rm -f coverage.out

echo ""
echo -e "${GREEN}✓${NC} All pre-commit checks passed"
echo ""

exit 0